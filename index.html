<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø³Ø¨Ø­Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ - Whisper</title>
    <style>
        :root {
            --primary: #10b981;
            --bg: #0f172a;
            --card-bg: #1e293b;
            --text: #f8fafc;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        /* Ø±Ø³Ø§Ù„Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù… */
        #status-container {
            background: #334155;
            padding: 15px 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
            width: 90%;
            max-width: 500px;
            border: 1px solid var(--primary);
        }

        .status-loading { color: #fbbf24; }
        .status-ready { color: #10b981; font-weight: bold; }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            width: 100%;
            max-width: 900px;
        }

        .card {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 20px;
            text-align: center;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .count { font-size: 3.5rem; font-weight: 900; color: var(--primary); margin: 10px 0; }

        /* ÙˆÙ…ÙŠØ¶ Ø§Ù„Ø°ÙƒØ± */
        .flash-active {
            animation: flash-green 0.6s ease-out;
        }

        @keyframes flash-green {
            0% { border-color: var(--primary); box-shadow: 0 0 20px var(--primary); transform: scale(1.05); }
            100% { border-color: transparent; box-shadow: none; transform: scale(1); }
        }

        .controls { margin-top: 30px; display: flex; gap: 10px; }
        
        button {
            padding: 15px 30px;
            border-radius: 50px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            font-size: 1rem;
            transition: 0.3s;
        }

        .btn-record { background: var(--primary); color: white; opacity: 0.5; cursor: not-allowed; }
        .recording { background: #ef4444; animation: pulse 1s infinite; }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        #log { margin-top: 20px; font-size: 0.8rem; color: #94a3b8; }
    </style>
</head>
<body>

    <h1>Ù…Ø³Ø¨Ø­Ø© Whisper Ø§Ù„Ø°ÙƒÙŠØ©</h1>

    <div id="status-container">
        <div id="status-text" class="status-loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØª (Whisper AI)...</div>
        <small id="progress-text">Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ø°Ù„Ùƒ Ø¯Ù‚ÙŠÙ‚Ø© ÙÙŠ Ø§Ù„Ù…Ø±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰</small>
    </div>

    <div class="grid" id="dhikr-grid">
        <div class="card" id="card-Ø§Ø³ØªØºÙØ± Ø§Ù„Ù„Ù‡" data-phrase="Ø§Ø³ØªØºÙØ± Ø§Ù„Ù„Ù‡">
            <h3>Ø£Ø³ØªØºÙØ± Ø§Ù„Ù„Ù‡</h3>
            <div class="count">0</div>
        </div>
        <div class="card" id="card-Ø³Ø¨Ø­Ø§Ù† Ø§Ù„Ù„Ù‡" data-phrase="Ø³Ø¨Ø­Ø§Ù† Ø§Ù„Ù„Ù‡">
            <h3>Ø³Ø¨Ø­Ø§Ù† Ø§Ù„Ù„Ù‡</h3>
            <div class="count">0</div>
        </div>
        <div class="card" id="card-Ø§Ù„Ø­Ù…Ø¯ Ù„Ù„Ù‡" data-phrase="Ø§Ù„Ø­Ù…Ø¯ Ù„Ù„Ù‡">
            <h3>Ø§Ù„Ø­Ù…Ø¯ Ù„Ù„Ù‡</h3>
            <div class="count">0</div>
        </div>
    </div>

    <div class="controls">
        <button id="record-btn" class="btn-record" disabled>Ø§Ù†ØªØ¸Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„...</button>
        <button style="background: #3b82f6; color: white;" onclick="addCustomDhikr()">â• Ø¥Ø¶Ø§ÙØ© Ø°ÙƒØ±</button>
    </div>

    <div id="log">Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø¬Ø§Ù‡Ø² Ù„Ø³Ù…Ø§Ø¹Ùƒ...</div>

    <script type="module">
        import { pipeline } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.6.0';

        let transcriber;
        let isRecording = false;
        let audioContext;
        let stream;
        let processor;
        
        const statusText = document.getElementById('status-text');
        const recordBtn = document.getElementById('record-btn');
        const log = document.getElementById('log');

        // 1. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
        async function loadModel() {
            try {
                transcriber = await pipeline('automatic-speech-recognition', 'Xenova/whisper-tiny', {
                    progress_callback: (p) => {
                        if (p.status === 'progress') {
                            document.getElementById('progress-text').innerText = `ØªÙ… ØªØ­Ù…ÙŠÙ„ ${Math.round(p.loaded)}% Ù…Ù† Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬`;
                        }
                    }
                });
                
                statusText.innerText = "âœ… Ø§Ù„Ù…Ø­Ø±Ùƒ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ù…Ù„";
                statusText.className = "status-ready";
                document.getElementById('progress-text').innerText = "ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø¢Ù†";
                recordBtn.disabled = false;
                recordBtn.innerText = "ğŸ¤ Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØªÙˆØ§ØµÙ„";
                recordBtn.style.opacity = "1";
                recordBtn.style.cursor = "pointer";
            } catch (e) {
                statusText.innerText = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„ØŒ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©";
                console.error(e);
            }
        }

        loadModel();

        // 2. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆÙ…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØª
        recordBtn.onclick = async () => {
            if (isRecording) {
                stopRecording();
                return;
            }
            startRecording();
        };

        async function startRecording() {
            isRecording = true;
            recordBtn.innerText = "ğŸ›‘ ØªÙˆÙ‚Ù";
            recordBtn.classList.add('recording');
            
            stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            audioContext = new AudioContext({ sampleRate: 16000 });
            const source = audioContext.createMediaStreamSource(stream);
            
            // Ø³Ù†Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¨Ø³ÙŠØ· ÙŠØ±Ø³Ù„ Ù…Ù‚Ø§Ø·Ø¹ ÙƒÙ„ 3 Ø«ÙˆØ§Ù†Ù Ù„Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
            const recorder = new MediaRecorder(stream);
            let chunks = [];

            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = async () => {
                const blob = new Blob(chunks, { type: 'audio/wav' });
                chunks = [];
                if (isRecording) {
                    processAudio(blob);
                    recorder.start(); // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¨Ø¯Ø¡ Ù„Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØªÙˆØ§ØµÙ„
                    setTimeout(() => { if(recorder.state === 'recording') recorder.stop(); }, 3000);
                }
            };

            recorder.start();
            setTimeout(() => { if(recorder.state === 'recording') recorder.stop(); }, 3000);
        }

        function stopRecording() {
            isRecording = false;
            recordBtn.innerText = "ğŸ¤ Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØªÙˆØ§ØµÙ„";
            recordBtn.classList.remove('recording');
            if (stream) stream.getTracks().forEach(t => t.stop());
        }

        async function processAudio(blob) {
            const buffer = await blob.arrayBuffer();
            const audioData = await audioContext.decodeAudioData(buffer);
            const float32Data = audioData.getChannelData(0);

            log.innerText = "Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØª Ø¨Ù€ Whisper...";
            
            const output = await transcriber(float32Data, {
                language: 'arabic',
                task: 'transcribe',
                chunk_length_s: 30,
            });

            const text = normalizeArabic(output.text);
            log.innerText = "Ø³Ù…Ø¹Øª: " + text;
            countWords(text);
        }

        function normalizeArabic(text) {
            return text.replace(/[Ø¥Ø£Ø¢Ø§]/g, "Ø§").replace(/Ø©/g, "Ù‡").replace(/[ÙÙ‹ÙÙŒÙÙÙ’Ù‘]/g, "").trim();
        }

        function countWords(text) {
            const cards = document.querySelectorAll('.card');
            cards.forEach(card => {
                const phrase = normalizeArabic(card.getAttribute('data-phrase'));
                const regex = new RegExp(phrase, "g");
                const matches = (text.match(regex) || []).length;
                
                if (matches > 0) {
                    const countEl = card.querySelector('.count');
                    let currentCount = parseInt(countEl.innerText);
                    countEl.innerText = currentCount + matches;
                    
                    // ØªØ£Ø«ÙŠØ± Ø§Ù„ÙˆÙ…ÙŠØ¶
                    card.classList.remove('flash-active');
                    void card.offsetWidth;
                    card.classList.add('flash-active');
                }
            });
        }

        window.addCustomDhikr = () => {
            const d = prompt("Ù…Ø§ Ø§Ù„Ø°ÙƒØ± Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø¥Ø¶Ø§ÙØªÙ‡ØŸ");
            if(d) {
                const grid = document.getElementById('dhikr-grid');
                const div = document.createElement('div');
                div.className = 'card';
                div.id = 'card-' + d;
                div.setAttribute('data-phrase', d);
                div.innerHTML = `<h3>${d}</h3><div class="count">0</div>`;
                grid.appendChild(div);
            }
        }
    </script>
</body>
</html>
