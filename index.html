<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø³Ø¨Ø­Ø© Whisper Ù…Ø¹ ÙˆØ§Ø¬Ù‡Ø© ØµÙˆØªÙŠØ©</title>
    <style>
        :root { --primary: #10b981; --bg: #0f172a; --card-bg: #1e293b; --text: #f8fafc; }
        body { font-family: system-ui, -apple-system, sans-serif; background-color: var(--bg); color: var(--text); padding: 20px; display: flex; flex-direction: column; align-items: center; margin: 0; }
        
        /* Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø£Ù…ÙˆØ§Ø¬ Ø§Ù„ØµÙˆØªÙŠØ© */
        #visualizer-container {
            width: 95%; max-width: 600px; height: 100px; background: #000;
            border-radius: 15px; margin-bottom: 15px; display: flex; align-items: center;
            justify-content: center; gap: 3px; overflow: hidden; border: 1px solid #334155;
        }
        .bar { width: 4px; height: 5px; background: var(--primary); border-radius: 2px; transition: height 0.1s ease; }

        #monitor-box {
            width: 95%; max-width: 600px; background: #1e293b; border: 1px solid #334155;
            padding: 15px; border-radius: 12px; margin-bottom: 20px; min-height: 40px;
            color: #fbbf24; font-family: monospace; font-size: 1rem; text-align: center;
        }

        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; width: 100%; max-width: 600px; }
        .card { background: var(--card-bg); padding: 20px; border-radius: 20px; text-align: center; border: 2px solid transparent; }
        .count { font-size: 2.5rem; font-weight: 900; color: var(--primary); }
        .flash-active { animation: pulse 0.4s ease; border-color: var(--primary); }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        .btn-record { 
            width: 70px; height: 70px; border-radius: 50%; border: none; 
            background: var(--primary); color: white; font-size: 1.5rem; cursor: pointer;
            margin-top: 20px; transition: 0.3s;
        }
        .recording { background: #ef4444; box-shadow: 0 0 20px rgba(239, 68, 68, 0.4); }
        button:disabled { opacity: 0.2; }
    </style>
</head>
<body>

    <div id="status">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø±Ùƒ...</div>

    <div id="visualizer-container">
        </div>

    <div id="monitor-box">Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø³Ù…ÙˆØ¹ Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§...</div>

    <div class="grid">
        <div class="card" data-keywords='["Ø§Ø³ØªØºÙØ± Ø§Ù„Ù„Ù‡", "Ø§Ø³ØªØºÙØ±Ø§Ù„Ù„Ù‡"]'>
            <div>Ø£Ø³ØªØºÙØ± Ø§Ù„Ù„Ù‡</div>
            <div class="count">0</div>
        </div>
        <div class="card" data-keywords='["Ø³Ø¨Ø­Ø§Ù† Ø§Ù„Ù„Ù‡", "Ø³Ø¨Ø­Ø§Ù†Ø§Ù„Ù„Ù‡"]'>
            <div>Ø³Ø¨Ø­Ø§Ù† Ø§Ù„Ù„Ù‡</div>
            <div class="count">0</div>
        </div>
        <div class="card" data-keywords='["Ø§Ù„Ø­Ù…Ø¯ Ù„Ù„Ù‡", "Ø§Ù„Ø­Ù…Ø¯Ù„Ù„Ù‡"]'>
            <div>Ø§Ù„Ø­Ù…Ø¯ Ù„Ù„Ù‡</div>
            <div class="count">0</div>
        </div>
        <div class="card" data-keywords='["Ù„Ø§ Ø­ÙˆÙ„ ÙˆÙ„Ø§", "Ù„Ø§Ø­ÙˆÙ„ ÙˆÙ„Ø§"]'>
            <div>Ø§Ù„Ø­ÙˆÙ‚Ù„Ø©</div>
            <div class="count">0</div>
        </div>
    </div>

    <button id="record-btn" class="btn-record" disabled>ğŸ¤</button>

    <script type="module">
        import { pipeline } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.6.0';

        let transcriber;
        let isRecording = false;
        let audioCtx, analyser, dataArray, source;
        const btn = document.getElementById('record-btn');
        const monitor = document.getElementById('monitor-box');

        // ØªÙˆÙ„ÙŠØ¯ Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø£Ù…ÙˆØ§Ø¬
        const visualizer = document.getElementById('visualizer-container');
        for (let i = 0; i < 60; i++) {
            const bar = document.createElement('div');
            bar.className = 'bar';
            visualizer.appendChild(bar);
        }
        const bars = document.querySelectorAll('.bar');

        async function init() {
            transcriber = await pipeline('automatic-speech-recognition', 'Xenova/whisper-tiny');
            document.getElementById('status').innerText = "âœ… Ø¬Ø§Ù‡Ø²";
            btn.disabled = false;
        }
        init();

        btn.onclick = async () => {
            if (isRecording) { location.reload(); return; } // Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ù„Ù„ØªÙˆÙ‚Ù Ø§Ù„Ø¨Ø³ÙŠØ·
            startApp();
        };

        async function startApp() {
            isRecording = true;
            btn.classList.add('recording');
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            
            // Ø¥Ø¹Ø¯Ø§Ø¯ Visualizer
            audioCtx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 16000 });
            analyser = audioCtx.createAnalyser();
            source = audioCtx.createMediaStreamSource(stream);
            source.connect(analyser);
            analyser.fftSize = 256;
            dataArray = new Uint8Array(analyser.frequencyBinCount);
            draw();

            // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø³Ø¬Ù„ Ù„Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
            const recorder = new MediaRecorder(stream);
            let chunks = [];
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = async () => {
                const blob = new Blob(chunks, { type: 'audio/wav' });
                chunks = [];
                if (isRecording) {
                    process(blob);
                    recorder.start();
                    setTimeout(() => recorder.stop(), 3000); // Ø­Ù„Ù„ ÙƒÙ„ 3 Ø«ÙˆØ§Ù†ÙŠ
                }
            };
            recorder.start();
            setTimeout(() => recorder.stop(), 3000);
        }

        function draw() {
            if (!isRecording) return;
            requestAnimationFrame(draw);
            analyser.getByteFrequencyData(dataArray);
            bars.forEach((bar, i) => {
                const val = dataArray[i % dataArray.length];
                bar.style.height = (val / 2) + 'px';
            });
        }

        async function process(blob) {
            const buffer = await blob.arrayBuffer();
            const decoded = await audioCtx.decodeAudioData(buffer);
            const result = await transcriber(decoded.getChannelData(0), { language: 'arabic', task: 'transcribe' });
            
            const text = result.text.trim();
            monitor.innerText = "Ø³Ù…Ø¹Øª: " + text;
            
            const cleanText = text.replace(/[Ø¥Ø£Ø¢Ø§]/g, "Ø§").replace(/Ø©/g, "Ù‡").replace(/[ÙÙ‹ÙÙŒÙÙÙ’Ù‘]/g, "");

            document.querySelectorAll('.card').forEach(card => {
                const keys = JSON.parse(card.getAttribute('data-keywords'));
                keys.forEach(key => {
                    const regex = new RegExp(key.replace(/[Ø¥Ø£Ø¢Ø§]/g, "Ø§").replace(/Ø©/g, "Ù‡"), "g");
                    const matches = (cleanText.match(regex) || []).length;
                    if (matches > 0) {
                        const countEl = card.querySelector('.count');
                        countEl.innerText = parseInt(countEl.innerText) + matches;
                        card.classList.add('flash-active');
                        setTimeout(() => card.classList.remove('flash-active'), 400);
                    }
                });
            });
        }
    </script>
</body>
</html>
