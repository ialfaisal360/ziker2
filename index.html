<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø³Ø¨Ø­Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©</title>
    <style>
        :root { --primary: #10b981; --bg: #0f172a; --card-bg: #1e293b; --text: #f8fafc; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: var(--text); padding: 20px; display: flex; flex-direction: column; align-items: center; margin: 0; }
        
        #monitor-box {
            width: 95%; max-width: 600px; background: #000; border: 2px solid var(--primary);
            padding: 20px; border-radius: 15px; margin-bottom: 20px; min-height: 80px;
            color: #adff2f; font-family: monospace; font-size: 1.2rem; text-align: center;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.1);
        }

        .status-badge { padding: 5px 15px; border-radius: 20px; font-size: 0.8rem; margin-bottom: 10px; }
        .loading { background: #fbbf24; color: #000; }
        .ready { background: var(--primary); color: #fff; }

        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; width: 100%; max-width: 600px; }
        .card { background: var(--card-bg); padding: 20px; border-radius: 20px; text-align: center; border: 3px solid transparent; transition: 0.2s; position: relative; }
        .count { font-size: 3rem; font-weight: 900; color: var(--primary); margin-top: 5px; }
        
        /* ÙˆÙ…ÙŠØ¶ Ø§Ø­ØªØ±Ø§ÙÙŠ */
        .flash-active { animation: ripple 0.6s linear; border-color: var(--primary); }
        @keyframes ripple { 0% { transform: scale(1); } 50% { transform: scale(1.08); } 100% { transform: scale(1); } }

        .btn-main { 
            width: 80px; height: 80px; border-radius: 50%; border: none; 
            background: var(--primary); color: white; font-size: 1.5rem; cursor: pointer;
            box-shadow: 0 0 15px var(--primary); margin-top: 30px; transition: 0.3s;
        }
        .btn-main.recording { background: #ef4444; box-shadow: 0 0 20px #ef4444; }
        .btn-main:disabled { opacity: 0.2; cursor: not-allowed; }
    </style>
</head>
<body>

    <div id="status-label" class="status-badge loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬ Ø¹Ø§Ù„ÙŠ Ø§Ù„Ø¯Ù‚Ø© (Base)...</div>
    
    <div id="monitor-box">Ø§Ù†ØªØ¸Ø± Ø­ØªÙ‰ ÙŠÙƒØªÙ…Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>

    <div class="grid">
        <div class="card" id="card-astaghfir" data-keywords='["Ø§Ø³ØªØºÙØ± Ø§Ù„Ù„Ù‡", "Ø§Ø³ØªØºÙØ±Ø§Ù„Ù„Ù‡", "Ø³ØªØºÙØ± Ø§Ù„Ù„Ù‡"]'>
            <div>Ø£Ø³ØªØºÙØ± Ø§Ù„Ù„Ù‡</div>
            <div class="count">0</div>
        </div>
        <div class="card" id="card-subhan" data-keywords='["Ø³Ø¨Ø­Ø§Ù† Ø§Ù„Ù„Ù‡", "Ø³Ø¨Ø­Ø§Ù† Ø§Ù„Ù„Ù‡"]'>
            <div>Ø³Ø¨Ø­Ø§Ù† Ø§Ù„Ù„Ù‡</div>
            <div class="count">0</div>
        </div>
        <div class="card" id="card-hamdulillah" data-keywords='["Ø§Ù„Ø­Ù…Ø¯ Ù„Ù„Ù‡", "Ø§Ù„Ø­Ù…Ø¯Ù„Ù„Ù‡"]'>
            <div>Ø§Ù„Ø­Ù…Ø¯ Ù„Ù„Ù‡</div>
            <div class="count">0</div>
        </div>
        <div class="card" id="card-hawqala" data-keywords='["Ù„Ø§ Ø­ÙˆÙ„ ÙˆÙ„Ø§ Ù‚ÙˆØ©", "Ù„Ø§Ø­ÙˆÙ„ ÙˆÙ„Ø§Ù‚ÙˆØ©"]'>
            <div>Ø§Ù„Ø­ÙˆÙ‚Ù„Ø©</div>
            <div class="count">0</div>
        </div>
    </div>

    <button id="record-btn" class="btn-main" disabled>ğŸ¤</button>
    <p id="progress-info" style="font-size: 0.8rem; margin-top: 10px; color: #94a3b8;"></p>

    <script type="module">
        import { pipeline } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.6.0';

        let transcriber;
        let isRecording = false;
        let audioCtx;
        let stream;

        const monitor = document.getElementById('monitor-box');
        const btn = document.getElementById('record-btn');
        const statusLabel = document.getElementById('status-label');

        // ØªØ­Ù…ÙŠÙ„ Ù†Ø³Ø®Ø© Whisper Base Ø§Ù„Ø£ÙƒØ«Ø± Ø¯Ù‚Ø©
        async function loadHighPrecisionModel() {
            try {
                transcriber = await pipeline('automatic-speech-recognition', 'Xenova/whisper-base', {
                    progress_callback: (p) => {
                        if (p.status === 'progress') {
                            document.getElementById('progress-info').innerText = `Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ ${Math.round(p.loaded)}% Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...`;
                        }
                    }
                });
                statusLabel.innerText = "âœ… Ø§Ù„Ù…Ø­Ø±Ùƒ Ø¹Ø§Ù„ÙŠ Ø§Ù„Ø¯Ù‚Ø© Ø¬Ø§Ù‡Ø²";
                statusLabel.className = "status-badge ready";
                monitor.innerText = "ØªØ­Ø¯Ø« Ø§Ù„Ø¢Ù† Ø¨Ù„Ù‡Ø¬ØªÙƒ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ©";
                btn.disabled = false;
            } catch (e) {
                statusLabel.innerText = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„!";
            }
        }
        loadHighPrecisionModel();

        btn.onclick = async () => {
            if (isRecording) {
                isRecording = false;
                btn.classList.remove('recording');
                if (stream) stream.getTracks().forEach(t => t.stop());
                return;
            }
            startEngine();
        };

        async function startEngine() {
            isRecording = true;
            btn.classList.add('recording');
            stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            audioCtx = new AudioContext({ sampleRate: 16000 });
            
            const recorder = new MediaRecorder(stream);
            let chunks = [];

            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = async () => {
                const blob = new Blob(chunks, { type: 'audio/wav' });
                chunks = [];
                if (isRecording) {
                    processVoice(blob);
                    recorder.start(); 
                    setTimeout(() => { if(recorder.state === 'recording') recorder.stop(); }, 3500);
                }
            };

            recorder.start();
            setTimeout(() => { if(recorder.state === 'recording') recorder.stop(); }, 3500);
        }

        async function processVoice(blob) {
            const buffer = await blob.arrayBuffer();
            const decoded = await audioCtx.decodeAudioData(buffer);
            const audio = decoded.getChannelData(0);

            // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¯Ù‚Ø©
            const result = await transcriber(audio, { 
                language: 'arabic',
                task: 'transcribe',
                return_timestamps: false,
                chunk_length_s: 30,
                stride_length_s: 5
            });

            let text = result.text.trim();
            monitor.innerText = text; // Ø¹Ø±Ø¶ Ø§Ù„Ù†Øµ Ø§Ù„Ø®Ø§Ù… Ù„Ù„ØªØ£ÙƒØ¯

            const cleanText = normalize(text);
            const cards = document.querySelectorAll('.card');

            cards.forEach(card => {
                const keywords = JSON.parse(card.getAttribute('data-keywords'));
                let foundCount = 0;

                keywords.forEach(key => {
                    const cleanKey = normalize(key);
                    const regex = new RegExp(cleanKey, "g");
                    const matches = (cleanText.match(regex) || []).length;
                    foundCount += matches;
                });

                if (foundCount > 0) {
                    const countEl = card.querySelector('.count');
                    countEl.innerText = parseInt(countEl.innerText) + foundCount;
                    card.classList.add('flash-active');
                    setTimeout(() => card.classList.remove('flash-active'), 600);
                }
            });
        }

        function normalize(t) {
            return t.replace(/[Ø¥Ø£Ø¢Ø§]/g, "Ø§")
                    .replace(/Ø©/g, "Ù‡")
                    .replace(/[ÙÙ‹ÙÙŒÙÙÙ’Ù‘]/g, "")
                    .replace(/[^\u0621-\u064A\s]/g, "") // Ø­Ø°Ù Ø£ÙŠ Ø±Ù…ÙˆØ² ØºÙŠØ± Ø¹Ø±Ø¨ÙŠØ©
                    .trim();
        }
    </script>
</body>
</html>
